#!/bin/bash

mkdir -p ~/.config/daylily



# Ensure Conda exists
if ! command -v conda &> /dev/null; then
    echo "Error: Conda is not available in this shell. Please install Miniconda."
    echo "Install with:"

    echo "     ./bin/install_miniconda "
    exit 3
fi

if ! command -v conda &> /dev/null; then
    echo "Error: Conda is not available in this shell. "
    echo "Install with:"
    echo "     ./bin/install_miniconda "
    exit 1
fi

REPO_ROOT=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
ENV_ALREADY_EXISTS=false

# Activate or create the Daylily CLI conda environment
if conda env list | grep -q "^DAY-EC "; then
    echo "Conda environment 'DAY-EC' already exists!"
    ENV_ALREADY_EXISTS=true
else
    echo "Creating 'DAY-EC' environment."
    conda env create -y -n DAY-EC -f config/day/daycli.yaml
    if [ $? -ne 0 ]; then
        echo "Error: Failed to create 'DAY-EC' environment."
        exit 1
    fi
fi

echo "Installing daylily-ephemeral-cluster into DAY-EC via editable pip install..."
if ! conda run -n DAY-EC python -m pip install --editable "$REPO_ROOT"; then
    echo "Error: Failed to install the CLI into the DAY-EC environment."
    exit 1
fi

if [ "$ENV_ALREADY_EXISTS" = true ]; then
    echo "Reinstalled daylily-ephemeral-cluster in the existing DAY-EC environment."
else
    echo "DAY-EC environment created successfully."
fi

echo "Daylily CLI environment is ready!  Activate with: "
echo "    conda activate DAY-EC"

echo " and to complete installing this package w/in the DAY-EC environment, run: "
echo "   pip install -e . "


# Install into the environment
conda run -n DAY-EC python -m pip install --editable "$REPO_ROOT"


# If this script was sourced, actually activate it
# (Detect if we are sourced by checking $BASH_SOURCE)
if [ "${BASH_SOURCE[0]}" != "$0" ]; then
    echo "Activating DAY-EC environment since script was sourced..."
    conda activate DAY-EC
    # optional: pip install again inside the active shell (to ensure console scripts)
    pip install -e "$REPO_ROOT"
else
    echo "Daylily CLI environment is ready. Run:"
    echo "    conda activate DAY-EC"
fi
