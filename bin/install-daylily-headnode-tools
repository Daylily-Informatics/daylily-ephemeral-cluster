#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_SOURCE_DIR="$REPO_ROOT/config"
TARGET_CONFIG_DIR="$HOME/.config/daylily"

mkdir -p "$TARGET_CONFIG_DIR"

cp "$CONFIG_SOURCE_DIR/daylily_cli_global.yaml" "$TARGET_CONFIG_DIR/daylily_cli_global.yaml"
cp "$CONFIG_SOURCE_DIR/daylily_available_repositories.yaml" "$TARGET_CONFIG_DIR/daylily_available_repositories.yaml"

# Install day-clone into a system-wide location if possible, otherwise fall back to ~/.local/bin
INSTALL_TARGET="/usr/local/bin/day-clone"
if command -v sudo >/dev/null 2>&1; then
    if sudo install -m 0755 "$REPO_ROOT/bin/day-clone" "$INSTALL_TARGET"; then
        echo "day-clone installed to $INSTALL_TARGET"
 
    else
        echo "Warning: failed to install day-clone to $INSTALL_TARGET with sudo. Falling back to user installation." >&2
    fi
fi

cd "$REPO_ROOT" || echo "Failed to cd to $REPO_ROOT" >&2
bin/install_miniconda || echo "failed to install miniconda"
bin/init_dayec || echo "failed to install day-ec"

reference_bucket=$(awk '/^[[:space:]]*Script: s3:/{match($0,/s3:\/\/([^/]+)/,a); print a[1]; exit}' /opt/parallelcluster/shared/cluster-config.yaml) || echo "failed to set ref bucket"
sed -i "s|<REF-BUCKET-NAME>|$reference_bucket|g"  ./etc/analysis_samples_template.tsv || echo "failed to regsub anasamptemp.tsv"


USER_BIN_DIR="$HOME/.local/bin"
mkdir -p "$USER_BIN_DIR"
install -m 0755 "$REPO_ROOT/bin/day-clone" "$USER_BIN_DIR/day-clone"
echo "day-clone installed to $USER_BIN_DIR/day-clone. Ensure $USER_BIN_DIR is on your PATH."
DYINIT_PATH="$REPO_ROOT/dyinit"
if [[ -f "$DYINIT_PATH" ]]; then
    BASHRC="$HOME/.bashrc"
    mkdir -p "$(dirname "$BASHRC")"
    if [[ ! -f "$BASHRC" ]]; then
        touch "$BASHRC"
    fi

    DYINIT_SNIPPET='source "$HOME/projects/daylily-ephemeral-cluster/dyinit" --skip-project-check'
    if ! grep -Fq "$DYINIT_SNIPPET" "$BASHRC"; then
        {
            echo ""
            echo "# Added by daylily-ephemeral-cluster to initialize the Day CLI"
            echo "if [ -f \"$HOME/projects/daylily-ephemeral-cluster/dyinit\" ]; then"
            echo "    source \"$HOME/projects/daylily-ephemeral-cluster/dyinit\" --skip-project-check"
            echo "fi"
        } >> "$BASHRC"
        echo "Configured ~/.bashrc to source dyinit on login."
    else
        echo "~/.bashrc already configured to source dyinit on login."
    fi
else
    echo "Warning: dyinit script not found at $DYINIT_PATH; skipping shell initialization update." >&2
fi

# Add initialization of dyinit  to automatically happen for ubuntu user

echo "" >> ~/.bashrc
echo ". ~/projects/daylily-ephemeral-cluster/dyinit" >> ~/.bashrc

echo "" >> ~/.bash_profile
echo ". ~/projects/daylily-ephemeral-cluster/dyinit" >> ~/.bash_profile
