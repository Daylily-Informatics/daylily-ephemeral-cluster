{% extends "base.html" %}
{% set active_page = 'manifest' %}

{% block title %}Analysis Manifest Generator - Daylily Customer Portal{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Analysis Manifest Generator</h1>
        <p class="page-subtitle">Create a <code>stage_samples.tsv</code> file defining analysis inputs for your pipeline run</p>
    </div>
    
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--spacing-xl);">
        <!-- Form Column -->
        <div>
            <form id="manifest-form" onsubmit="generateManifest(event)">
                <!-- Run Configuration -->
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-cogs"></i> Run Configuration</h3>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="run_id" class="form-label required">Run ID</label>
                            <input type="text" id="run_id" name="run_id" class="form-control" 
                                   placeholder="RUN001" required oninput="updateManifestPreview()">
                            <small class="text-muted">Unique identifier for this analysis run</small>
                        </div>
                        <div class="form-group">
                            <label for="stage_target" class="form-label">Stage Target</label>
                            <input type="text" id="stage_target" name="stage_target" class="form-control" 
                                   value="/fsx/staged_sample_data/" oninput="updateManifestPreview()">
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Inputs (Samples) -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-dna"></i> Analysis Inputs</h3>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addAnalysisInput()">
                            <i class="fas fa-plus"></i> Add Input
                        </button>
                    </div>
                    
                    <p class="text-muted mb-md" style="font-size: 0.875rem;">
                        Each analysis input represents a sequencing library to be processed. 
                        This corresponds to a row in <code>stage_samples.tsv</code>.
                    </p>

                    <div id="inputs-container">
                        <!-- Analysis input rows will be added here -->
                    </div>

                    <div class="mt-lg">
                        <input type="file" id="tsv-upload" accept=".tsv,.csv,.txt" class="d-none" onchange="loadInputsFromTSV(this)">
                        <div class="d-flex gap-sm flex-wrap">
                            <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('tsv-upload').click()">
                                <i class="fas fa-file-upload"></i> Import TSV/CSV
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" onclick="downloadTemplate()">
                                <i class="fas fa-file-download"></i> Download Template
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" onclick="discoverFromS3()">
                                <i class="fas fa-search"></i> Discover from S3
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Terminology Guide -->
                <div class="card">
                    <details>
                        <summary class="card-title" style="cursor: pointer;">
                            <i class="fas fa-book"></i> Terminology Guide (GA4GH Standards)
                        </summary>
                        <div class="mt-lg terminology-guide">
                            <dl>
                                <dt><strong>Analysis Input (SAMPLE_ID)</strong></dt>
                                <dd>Pipeline input identifier - uniquely identifies a sequencing library for analysis</dd>
                                
                                <dt><strong>Subject/Individual (EXTERNAL_SAMPLE_ID)</strong></dt>
                                <dd>Source organism identifier (e.g., patient ID, HG002). Multiple libraries may come from one subject.</dd>
                                
                                <dt><strong>Biosample</strong></dt>
                                <dd>Physical specimen (tissue type, collection info). Captured in SAMPLE_TYPE field.</dd>
                                
                                <dt><strong>Sequencing Library</strong></dt>
                                <dd>Prepared DNA/RNA with specific protocol. Captured in LIB_PREP, SEQ_VENDOR, SEQ_PLATFORM.</dd>
                                
                                <dt><strong>FASTQ Files</strong></dt>
                                <dd>Raw sequencing output files (R1_FQ, R2_FQ). Include full S3 paths.</dd>
                            </dl>
                        </div>
                    </details>
                </div>
            </form>
        </div>
        
        <!-- Preview Column -->
        <div>
            <div class="card" style="position: sticky; top: 90px;">
                <div class="card-header">
                    <h3 class="card-title">Manifest Preview (TSV)</h3>
                    <div class="d-flex gap-sm">
                        <button class="btn btn-outline btn-sm" onclick="copyManifest()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="downloadManifest()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="code-block" style="max-height: 500px; overflow: auto;">
                    <pre id="manifest-preview" style="white-space: pre; overflow-x: auto;"># Add analysis inputs to generate the manifest</pre>
                </div>
                
                <!-- Column Reference -->
                <div class="mt-md p-md" style="background: var(--color-gray-100); border-radius: var(--radius-md); font-size: 0.8rem;">
                    <strong>Required Columns:</strong>
                    <code>RUN_ID, SAMPLE_ID, EXPERIMENTID, SAMPLE_TYPE, LIB_PREP, SEQ_VENDOR, SEQ_PLATFORM, LANE, SEQBC_ID, PATH_TO_CONCORDANCE_DATA_DIR, R1_FQ, R2_FQ, STAGE_DIRECTIVE, STAGE_TARGET, SUBSAMPLE_PCT, IS_POS_CTRL, IS_NEG_CTRL, N_X, N_Y, EXTERNAL_SAMPLE_ID</code>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Input Modal (for editing individual inputs) -->
<div class="modal-overlay" id="input-edit-modal">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Analysis Input</h3>
            <button class="modal-close" onclick="closeInputModal()">&times;</button>
        </div>
        <div class="modal-body" id="input-modal-body">
            <!-- Dynamic form fields will be inserted here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeInputModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveInputFromModal()">Save</button>
        </div>
    </div>
</div>

<!-- File Browser Modal -->
<div class="modal-overlay" id="file-browser-modal">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3><i class="fas fa-folder-open"></i> Select FASTQ from S3</h3>
            <button class="modal-close" onclick="closeFileBrowser()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="mb-md">
                <nav class="breadcrumb" id="browser-breadcrumb">
                    <a href="#" onclick="browseFolder('')" class="breadcrumb-item">
                        <i class="fas fa-home"></i> Root
                    </a>
                </nav>
            </div>
            <div class="file-list" id="browser-file-list" style="max-height: 400px; overflow-y: auto;">
                <div class="text-center text-muted p-xl">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-md">Loading files...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeFileBrowser()">Cancel</button>
        </div>
    </div>
</div>

<style>
.analysis-input-row {
    padding: var(--spacing-md);
    background: var(--color-gray-100);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
    border-left: 3px solid var(--color-accent);
}
.analysis-input-row:last-child { margin-bottom: 0; }
.analysis-input-row .input-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}
.analysis-input-row .input-title {
    font-weight: 600;
    color: var(--color-accent);
}
.analysis-input-row .input-summary {
    font-size: 0.875rem;
    color: var(--color-gray-600);
}
.terminology-guide dt {
    color: var(--color-accent);
    margin-top: var(--spacing-sm);
}
.terminology-guide dd {
    margin-left: 0;
    color: var(--color-gray-600);
    font-size: 0.875rem;
}
details summary::-webkit-details-marker { display: none; }
details summary { list-style: none; }
.input-group {
    display: flex;
    gap: 0;
}
.input-group .form-control {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}
.input-group .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    border-left: none;
}
.file-list-item {
    display: flex;
    align-items: center;
    padding: var(--spacing-sm) var(--spacing-md);
    border-bottom: 1px solid var(--color-gray-200);
    cursor: pointer;
}
.file-list-item:hover { background-color: var(--color-gray-100); }
.file-list-item i { margin-right: var(--spacing-sm); width: 20px; text-align: center; }
.file-list-item.folder i { color: var(--color-warning); }
.file-list-item.file i { color: var(--color-gray-500); }
.breadcrumb { display: flex; align-items: center; flex-wrap: wrap; gap: var(--spacing-xs); }
.breadcrumb-item { color: var(--color-accent); cursor: pointer; }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Customer ID for file browsing
window.DaylilyConfig = window.DaylilyConfig || {};
window.DaylilyConfig.customerId = '{{ customer.customer_id | default("") }}';
</script>
<script src="/static/js/manifest-generator.js?v={{ cache_bust | default('1') }}"></script>
{% endblock %}

