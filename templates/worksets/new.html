{% extends "base.html" %}
{% set active_page = 'worksets' %}

{% block title %}Submit New Workset - Daylily Customer Portal{% endblock %}

{% block content %}
<div class="container container-sm">
    <!-- Page Header -->
    <div class="page-header">
        <a href="/portal/worksets" class="text-muted mb-md d-block">
            <i class="fas fa-arrow-left"></i> Back to Worksets
        </a>
        <h1 class="page-title">Submit New Workset</h1>
        <p class="page-subtitle">Configure and submit a new genomics processing job</p>
    </div>

    <!-- Quick Start Guide -->
    <div class="card" style="background: linear-gradient(135deg, #1a3a4a, #0d2633); border-left: 4px solid var(--color-accent);">
        <h4 style="margin-top: 0; color: #fff;"><i class="fas fa-lightbulb text-warning"></i> Quick Start Guide</h4>
        <p style="margin-bottom: var(--spacing-sm); color: #c8d4db;">A <strong>workset</strong> is a batch of samples to be processed together through a genomics pipeline. To submit a workset:</p>
        <ol style="margin: 0; padding-left: var(--spacing-lg); line-height: 1.8; color: #c8d4db;">
            <li><strong>Name your workset</strong> &mdash; Use a descriptive name like "ProjectX-Cohort1-Jan2024"</li>
            <li><strong>Select pipeline &amp; reference</strong> &mdash; Choose the analysis type and reference genome</li>
            <li><strong>Provide input data</strong> &mdash; Upload FASTQ files, specify an S3 path, or upload a YAML config</li>
            <li><strong>Configure options</strong> &mdash; Set priority, notifications, and QC preferences</li>
        </ol>
    </div>

    <!-- Submission Form -->
    <form id="workset-form" onsubmit="submitWorkset(event)">
        <!-- Step 1: Basic Info -->
        <div class="card">
            <h3 class="card-title"><span class="badge badge-in-progress">1</span> Basic Information</h3>
            <p class="text-muted mb-lg">Identify your workset and select the analysis pipeline. This information helps organize your results and ensures the correct processing workflow is applied.</p>

            <div class="form-group">
                <label for="workset_name" class="form-label required">Workset Name</label>
                <input type="text" id="workset_name" name="workset_name" class="form-control"
                       placeholder="e.g., Patient-Cohort-2024-01" required>
                <p class="form-text">A descriptive name for this processing job. Use alphanumeric characters, dashes, and underscores. This name will appear in your workset list and output files.</p>
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label for="pipeline_type" class="form-label required">Pipeline Type</label>
                    <select id="pipeline_type" name="pipeline_type" class="form-control form-select" required>
                        <option value="">Select pipeline...</option>
                        <option value="germline">Germline Variant Calling</option>
                        <option value="somatic">Somatic Variant Calling</option>
                        <option value="rnaseq">RNA-Seq Analysis</option>
                        <option value="wgs">Whole Genome Sequencing</option>
                        <option value="wes">Whole Exome Sequencing</option>
                    </select>
                    <p class="form-text">
                        <strong>Germline:</strong> Inherited variants &bull;
                        <strong>Somatic:</strong> Tumor vs normal &bull;
                        <strong>RNA-Seq:</strong> Gene expression
                    </p>
                </div>

                <div class="form-group">
                    <label for="reference_genome" class="form-label required">Reference Genome</label>
                    <select id="reference_genome" name="reference_genome" class="form-control form-select" required>
                        <option value="">Select reference...</option>
                        <option value="GRCh38">GRCh38 (hg38) - Human</option>
                        <option value="GRCh37">GRCh37 (hg19) - Human</option>
                        <option value="T2T-CHM13">T2T-CHM13 - Human (Telomere-to-Telomere)</option>
                        <option value="GRCm39">GRCm39 (mm39) - Mouse</option>
                    </select>
                    <p class="form-text">
                        <strong>GRCh38:</strong> Current standard &bull;
                        <strong>GRCh37:</strong> Legacy compatibility &bull;
                        <strong>T2T:</strong> Complete assembly
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Input Files -->
        <div class="card">
            <h3 class="card-title"><span class="badge badge-in-progress">2</span> Input Files</h3>
            <p class="text-muted mb-lg">Specify where your sequencing data is located. Choose the method that best fits your workflow:</p>

            <div class="tabs">
                <ul class="tab-list">
                    <li class="tab-item active" onclick="switchTab('upload')">
                        <i class="fas fa-upload"></i> Upload Files
                    </li>
                    <li class="tab-item" onclick="switchTab('s3')">
                        <i class="fab fa-aws"></i> S3 Path
                    </li>
                    <li class="tab-item" onclick="switchTab('yaml')">
                        <i class="fas fa-file-code"></i> Upload YAML
                    </li>
                </ul>
            </div>

            <!-- Upload Tab -->
            <div class="tab-content active" id="tab-upload">
                <div class="alert alert-info mb-lg" style="background: #0d3344; border: 1px solid var(--color-info); border-radius: var(--radius-md); padding: var(--spacing-md); color: #b8d4e8;">
                    <i class="fas fa-info-circle text-info"></i>
                    <strong style="color: #fff;">Best for:</strong> Small to medium datasets (&lt;50GB total). Files are uploaded to your S3 bucket and a workset configuration is auto-generated.
                </div>
                <div class="file-upload" id="file-dropzone">
                    <div class="file-upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <p class="file-upload-text">
                        <strong>Drag and drop</strong> your FASTQ files here, or <strong>click to browse</strong>
                    </p>
                    <p class="text-muted" style="font-size: 0.875rem;">
                        Supported: .fastq, .fastq.gz, .fq.gz (Max 50GB per file)
                    </p>
                    <input type="file" id="file-input" class="file-upload-input"
                           multiple accept=".fastq,.fq,.fastq.gz,.fq.gz">
                </div>
                <p class="form-text mt-md">
                    <i class="fas fa-lightbulb text-warning"></i>
                    <strong>Tip:</strong> Name your files using the pattern <code>SampleName_R1.fastq.gz</code> / <code>SampleName_R2.fastq.gz</code> or <code>SampleName.R1.fastq.gz</code> / <code>SampleName.R2.fastq.gz</code> for paired-end reads. The system will automatically pair them.
                </p>

                <div id="file-list" class="mt-lg d-none">
                    <h4>Selected Files</h4>
                    <ul id="file-items" class="list-unstyled"></ul>
                </div>
            </div>

            <!-- S3 Tab -->
            <div class="tab-content" id="tab-s3">
                <div class="alert alert-info mb-lg" style="background: #0d3344; border: 1px solid var(--color-info); border-radius: var(--radius-md); padding: var(--spacing-md); color: #b8d4e8;">
                    <i class="fas fa-info-circle text-info"></i>
                    <strong style="color: #fff;">Best for:</strong> Large datasets or data already in S3. Point to an existing folder containing your FASTQ files and <code style="background: #1a4a5e; padding: 2px 6px; border-radius: 3px;">daylily_work.yaml</code>.
                </div>
                <div class="form-group">
                    <label for="s3_bucket" class="form-label">S3 Bucket</label>
                    <input type="text" id="s3_bucket" name="s3_bucket" class="form-control"
                           placeholder="your-bucket-name" value="{{ customer.s3_bucket | default('') }}">
                    <p class="form-text">Your designated S3 bucket (pre-filled from your account settings)</p>
                </div>
                <div class="form-group">
                    <label for="s3_prefix" class="form-label">S3 Prefix (Path)</label>
                    <div class="input-group">
                        <input type="text" id="s3_prefix" name="s3_prefix" class="form-control"
                               placeholder="worksets/my-workset/">
                        <button type="button" id="discover-s3-samples" class="btn btn-outline" title="Discover samples from S3">
                            <i class="fas fa-search"></i> Discover
                        </button>
                    </div>
                    <p class="form-text">Path to the folder containing your FASTQ files. Click <strong>Discover</strong> to auto-detect samples.</p>
                </div>
                <div id="s3-samples-preview"></div>
                <div class="alert alert-info mt-lg" style="background: #0d3344; border: 1px solid var(--color-info); border-radius: var(--radius-md); padding: var(--spacing-md); color: #b8d4e8;">
                    <i class="fas fa-lightbulb text-warning"></i>
                    <strong style="color: #fff;">Tip:</strong> Click <strong>Discover</strong> to automatically find FASTQ files and <code style="background: #1a4a5e; padding: 2px 6px; border-radius: 3px;">daylily_work.yaml</code> in your S3 path.
                    If no config file exists, <a href="/portal/yaml-generator" class="text-accent">generate one here</a>.
                </div>
            </div>

            <!-- YAML Tab -->
            <div class="tab-content" id="tab-yaml">
                <div class="alert alert-info mb-lg" style="background: #0d3344; border: 1px solid var(--color-info); border-radius: var(--radius-md); padding: var(--spacing-md); color: #b8d4e8;">
                    <i class="fas fa-info-circle text-info"></i>
                    <strong style="color: #fff;">Best for:</strong> Advanced users with pre-configured worksets. Upload an existing <code style="background: #1a4a5e; padding: 2px 6px; border-radius: 3px;">daylily_work.yaml</code> that defines your samples and analysis parameters.
                </div>
                <div class="form-group">
                    <label for="yaml_file" class="form-label">Upload daylily_work.yaml</label>
                    <div class="file-upload" onclick="document.getElementById('yaml-input').click()">
                        <div class="file-upload-icon"><i class="fas fa-file-code"></i></div>
                        <p class="file-upload-text">
                            Click to upload your <code>daylily_work.yaml</code> configuration
                        </p>
                        <input type="file" id="yaml-input" class="file-upload-input" accept=".yaml,.yml">
                    </div>
                    <div id="yaml-preview" class="mt-lg d-none">
                        <h4>YAML Preview</h4>
                        <div class="code-block">
                            <pre id="yaml-content"></pre>
                        </div>
                    </div>
                </div>
                <div class="mt-lg" style="background: #1a2a33; border-radius: var(--radius-md); padding: var(--spacing-md); border: 1px solid #2a3a44;">
                    <p class="mb-sm" style="color: #fff;"><strong>Don't have a YAML config?</strong></p>
                    <p class="mb-md" style="color: #a8b8c8;">Use our YAML Generator wizard to create one. It will guide you through sample definition, read pairing, and analysis options.</p>
                    <a href="/portal/yaml-generator" class="btn btn-outline btn-sm">
                        <i class="fas fa-magic"></i> Open YAML Generator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Processing Options -->
        <div class="card">
            <h3 class="card-title"><span class="badge badge-in-progress">3</span> Processing Options</h3>
            <p class="text-muted mb-lg">Configure execution priority, notifications, and output options for your workset.</p>

            <div class="grid grid-2">
                <div class="form-group">
                    <label for="priority" class="form-label">Priority</label>
                    <select id="priority" name="priority" class="form-control form-select">
                        <option value="normal">Normal (Standard pricing)</option>
                        <option value="high">High (2x cost, faster start)</option>
                        <option value="low">Low (50% cost, spot instances)</option>
                    </select>
                    <p class="form-text">
                        <strong>Normal:</strong> Queue-based processing, typically starts within 1 hour<br>
                        <strong>High:</strong> Dedicated resources, starts immediately<br>
                        <strong>Low:</strong> Uses interruptible spot instances, may be delayed
                    </p>
                </div>

                <div class="form-group">
                    <label for="notification_email" class="form-label">Notification Email</label>
                    <input type="email" id="notification_email" name="notification_email" class="form-control"
                           placeholder="notify@company.com" value="{{ customer.email | default('') }}">
                    <p class="form-text">Receive email notifications when your workset completes, fails, or requires attention.</p>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--color-gray-700); margin: var(--spacing-lg) 0;">

            <h4 style="margin-bottom: var(--spacing-md);">Output Options</h4>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="enable_qc" name="enable_qc" checked>
                    <span><strong>Enable Quality Control reports</strong></span>
                </label>
                <p class="form-text" style="margin-left: 24px;">Generate FastQC reports for individual samples and MultiQC summary reports. Recommended for all production runs.</p>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="archive_results" name="archive_results" checked>
                    <span><strong>Archive results to S3 Glacier after 30 days</strong></span>
                </label>
                <p class="form-text" style="margin-left: 24px;">Automatically move results to low-cost Glacier storage after 30 days. Reduces storage costs by ~80% while keeping data accessible.</p>
            </div>
        </div>

        <!-- Cost Estimate -->
        <div class="card" id="cost-estimate">
            <h3 class="card-title"><i class="fas fa-calculator"></i> Cost Estimate</h3>
            <p class="text-muted mb-lg">Estimated costs based on your selected options. Actual costs may vary depending on data complexity and coverage depth.</p>
            <div class="grid grid-3">
                <div>
                    <div class="stat-value text-accent" id="est-cost">$0.00</div>
                    <div class="stat-label">Estimated Cost</div>
                </div>
                <div>
                    <div class="stat-value" id="est-time">0h</div>
                    <div class="stat-label">Estimated Time</div>
                </div>
                <div>
                    <div class="stat-value" id="est-vcpu">0</div>
                    <div class="stat-label">vCPU Hours</div>
                </div>
            </div>
            <div class="mt-lg" style="background: #1a2a33; border-radius: var(--radius-md); padding: var(--spacing-md); border: 1px solid #2a3a44;">
                <p style="font-size: 0.875rem; margin: 0; color: #a8b8c8;">
                    <i class="fas fa-info-circle" style="color: #5bc0de;"></i>
                    <strong style="color: #fff;">How costs are calculated:</strong> Base compute cost + storage + data transfer.
                    High priority adds a 2x multiplier. Low priority uses spot pricing (~50% savings but may be interrupted).
                    QC reports add ~5% to compute time. View <a href="/portal/usage" class="text-accent">detailed pricing</a>.
                </p>
            </div>
        </div>
        
        <!-- Submit -->
        <div class="d-flex justify-between mt-xl">
            <a href="/portal/worksets" class="btn btn-outline">Cancel</a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-rocket"></i> Submit Workset
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/worksets.js?v={{ cache_bust | default('1') }}"></script>
<script src="/static/js/file-upload.js?v={{ cache_bust | default('1') }}"></script>
{% endblock %}

